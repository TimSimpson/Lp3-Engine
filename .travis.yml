language: cpp

dist: trusty
sudo: false

matrix:
  include:
    - os: linux
      compiler: gcc
      addons:
        apt:
          sources:
            - ubuntu-toolchain-r-test
          packages:
            - gcc-6
            - g++-6
            - ninja-build
            - libfreetype6-dev
            - libboost-dev
      env:
        - CENV_NAME=gcc64r
          CI_C=gcc-6
          CI_CXX=g++-6
          CI_BUILD_TYPE=Release
    - os: linux
      compiler: gcc
      addons:
        apt:
          sources:
            - ubuntu-toolchain-r-test
          packages:
            - gcc-6
            - g++-6
            - ninja-build
            - libfreetype6-dev
            - libboost-dev
      env:
        - CENV_NAME=gcc64d
          CI_C=gcc-6
          CI_CXX=g++-6
          CI_BUILD_TYPE=Debug
    - os: linux
      compiler: clang
      addons:
        apt:
          sources:
            - ubuntu-toolchain-r-test
            - llvm-toolchain-precise
          packages:
            - clang-3.8
            - clang-format-3.8
            - clang-tidy-3.8
            - libstdc++6
            - ninja-build
            - libfreetype6-dev
            - libboost-dev
      env:
        - CENV_NAME=clang64r
          CI_C=clang-3.8
          CI_CXX=clang++-3.8
          CI_BUILD_TYPE=Release
    - os: linux
      compiler: clang
      addons:
        apt:
          sources:
            - ubuntu-toolchain-r-test
            - llvm-toolchain-precise
          packages:
            - clang-3.8
            - clang-format-3.8
            - clang-tidy-3.8
            - libstdc++6
            - ninja-build
            - libfreetype6-dev
            - libboost-dev
      env:
        - CENV_NAME=clang64d
          CI_C=clang-3.8
          CI_CXX=clang++-3.8
          CI_BUILD_TYPE=Debug

install:
  - |
    set -e
    pushd /tmp
    travis_retry wget --quiet --no-check-certificate https://cmake.org/files/v3.8/cmake-3.8.0-rc2-Linux-x86_64.tar.gz
    tar -xf cmake-3.8.0-rc2-Linux-x86_64.tar.gz
    git clone https://github.com/TimSimpson/cenv.git
    travis_retry wget --quiet https://github.com/TimSimpson/cenv/archive/master.tar.gz
    tar -xf master.tar.gz
    pushd cenv-master
    ./install.sh
    popd
    popd

script:
  - |
    set -e
    export PATH=/tmp/cmake-3.8.0-rc2-Linux-x86_64/bin:/tmp/cenv-master/output/bvenv/bin/:${PATH}
    cmake --version
    git submodule update --init --recursive
    cget init --std=c++14 -DCMAKE_C_COMPILER:none=${CI_C} -DCMAKE_CXX_COMPILER:none=${CI_CXX} -DCMAKE_BUILD_TYPE:none=${CI_BUILD_TYPE}
    cget install TimSimpson/cget-recipes
    cget install libpng
    cget install -f requirements.txt
    mkdir build
    cd build
    cmake -G Ninja -DCMAKE_TOOLCHAIN_FILE=../cget/cget/cget.cmake -H../standalone -B./
    cmake --build ./
    export CTEST_OUTPUT_ON_FAILURE=1
    export PATH=$(pwd)/../cget/lib:${PATH}
    export LD_LIBRARY_PATH=${LD_LIBRARY_PATH}:$(pwd)/../cget/lib
    export LP3_ROOT_PATH=$(pwd)/../standalone/media
    ctest
