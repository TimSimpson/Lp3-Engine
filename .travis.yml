language: cpp

dist: trusty
sudo: false

cache:
  directories:
  - ./cget

matrix:
  include:
    - name: "GCC 6 Release"
      os: linux
      compiler: gcc
      addons:
        apt:
          sources:
            - ubuntu-toolchain-r-test
          packages:
            - gcc-6
            - g++-6
            - ninja-build
            - libfreetype6-dev
            - libboost-dev
      env:
        - CENV_NAME=gcc64r
          CI_C=gcc-6
          CI_CXX=g++-6
          CI_BUILD_TYPE=Release
    - name: "GCC 6 Debug"
      os: linux
      compiler: gcc
      addons:
        apt:
          sources:
            - ubuntu-toolchain-r-test
          packages:
            - gcc-6
            - g++-6
            - ninja-build
            - libfreetype6-dev
            - libboost-dev
      env:
        - CENV_NAME=gcc64d
          CI_C=gcc-6
          CI_CXX=g++-6
          CI_BUILD_TYPE=Debug
    - name: "Clang 3.8 Release"
      os: linux
      compiler: clang
      addons:
        apt:
          sources:
            - ubuntu-toolchain-r-test
            - llvm-toolchain-precise
          packages:
            - gcc-6
            - g++-6
            - clang-3.8
            - clang-format-3.8
            - clang-tidy-3.8
            - libstdc++6
            - ninja-build
            - libfreetype6-dev
            - libboost-dev
      env:
        - CENV_NAME=clang64r
          CI_C=clang-3.8
          CI_CXX=clang++-3.8
          CI_BUILD_TYPE=Release
    - name: "Clang 3.8 Debug"
      os: linux
      compiler: clang
      addons:
        apt:
          sources:
            - ubuntu-toolchain-r-test
            - llvm-toolchain-precise
          packages:
            - gcc-6
            - g++-6
            - clang-3.8
            - clang-format-3.8
            - clang-tidy-3.8
            - libstdc++6
            - ninja-build
            - libfreetype6-dev
            - libboost-dev
      env:
        - CENV_NAME=clang64d
          CI_C=clang-3.8
          CI_CXX=clang++-3.8
          CI_BUILD_TYPE=Debug

install:
  - |
    pip install --user cmake cget

script:
  - |
    set -e
    $CI_CXX --version
    cmake --version
    git submodule update --init --recursive
    if [ -d "cget" ]; then
      echo 'Hoping the c env is cached...'
      ls -la cget
    else
      echo 'Creating new c-env...'
      cget init --std=c++14 -DCMAKE_C_COMPILER:none=${CI_C} -DCMAKE_CXX_COMPILER:none=${CI_CXX} -DCMAKE_BUILD_TYPE:none=${CI_BUILD_TYPE} -DCMAKE_CXX_STANDARD=14
    fi
    cget install TimSimpson/cget-recipes
    cget install libpng
    cget install -f requirements.txt
    mkdir build
    cd build
    cmake -G Ninja -DCMAKE_TOOLCHAIN_FILE=../cget/cget/cget.cmake -H../standalone -B./
    cmake --build ./
    export CTEST_OUTPUT_ON_FAILURE=1
    export PATH=$(pwd)/../cget/lib:${PATH}
    export LD_LIBRARY_PATH=${LD_LIBRARY_PATH}:$(pwd)/../cget/lib
    export LP3_ROOT_PATH=$(pwd)/../standalone/media
    ctest
